#!/bin/bash

if [[ -e "$(home_as_home "${1:-.}")" ]]; then
  HOME_AS_HOME=$(home_as_home "${1:-.}")
else
  FZF_QUERY="$1"
  HOME_AS_HOME=$(home_as_home .)
fi
HOME_AS_TILDE=$(home_as_tilde "${HOME_AS_HOME}")

FZF_PROMPT="$(basename $0)"
FZF_HEADER="C-g:ripgrep, C-/:TogglePreview"

FIND_CMD="find -s ${HOME_AS_HOME}"\
" -not -regex '.*/.git'"\
" -not -regex '.*/.git/.*'"\
" -not -regex '.*\.DS_Store'"

FZF_RESULT=$(eval ${FIND_CMD} \
  | home_as_tilde \
  | fzf \
    +m \
    --info=inline \
    --query="${FZF_QUERY}" \
    --prompt="${FZF_PROMPT} (dir='${HOME_AS_TILDE}') > " \
    --header="${FZF_HEADER}" \
    --bind "ctrl-/:toggle-preview" \
    --bind "ctrl-g:execute(rg_fzf_vim . ${HOME_AS_HOME} < /dev/tty > /dev/tty)" \
    --preview='bat $(home_as_home {}) --color=always --style=numbers --line-range :100'\
)

if [[ -z "${FZF_RESULT}" ]]; then
  #echo -n "$1"
  exit 1
else
  FZF_RESULT=$(home_as_home "${FZF_RESULT}")
  if [[ -d "${FZF_RESULT}" && "${FZF_RESULT: -1}" != "/" ]]; then
    FZF_RESULT="${FZF_RESULT}/"
  fi
  echo -n "${FZF_RESULT}"
  exit 0
fi

