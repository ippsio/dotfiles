#!/usr/bin/env bash
if [[ -z "$1" || "$1" == "." || "$1" == "./" ]]; then
  TARGET_DIR="."
  FZF_QUERY=""
else
  # 2連続以上のスラッシュが与えられた場合、単一のスラッシュにします。
  TARGET_DIR=$(echo "$1"| sed -r 's#/+#/#g')
  # パスが${HOME}のものなら~/を${HOME}の値に置換します。
  TARGET_DIR=$(echo "${TARGET_DIR}"| home_as_home)
  # 存在しないパスなら処理を終了します。
  [[ ! -e "$(home_as_home ${TARGET_DIR})" ]] && exit
  FZF_QUERY="${TARGET_DIR_TILDE}"
fi
FZF_PROMPT="$(basename $0) (dir='$(home_as_tilde ${TARGET_DIR})') > "
FZF_RESULT=$(rg --files --hidden --no-ignore "${TARGET_DIR}" 2>/dev/null| grep -v "^${TARGET_DIR}$"| sed 's#^./##' | home_as_tilde\
  | fzf +m --query="${FZF_QUERY} " --header="C-g:ripgrep, C-/:TogglePreview" --prompt="${FZF_PROMPT}" \
    --bind "ctrl-/:toggle-preview" --bind "ctrl-_:toggle-preview" \
    --bind "ctrl-g:execute(rg_fzf_vim . ${TARGET_DIR} < /dev/tty > /dev/tty)" \
    --preview-window=right:60%:wrap --preview='
      real_path_file="$(home_as_home {}| xargs realpath)"
      true_if_git_repo=$(cd $(dirname "${real_path_file}"); git rev-parse --is-inside-work-tree 2> /dev/null)
      if ( is_binary "${real_path_file}" ); then
        home_as_tilde "${real_path_file}"
        printf "---\n<<<< BINARY FILE >>>>\n"
        exiftool -t "${real_path_file}"| cat -n
        echo "---"
        bat -A "${real_path_file}"
      elif [[ "${true_if_git_repo}" == "true" ]]; then
        git_blame_colored "${real_path_file}"
      else
        bat "$(home_as_home {})" --color=always --style=numbers --line-range :100
      fi
    ')
if [[ $? -eq 0 ]]; then
  home_as_tilde "${FZF_RESULT}"
else
  printf "%s" "$1"
fi
