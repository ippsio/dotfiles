#!/bin/bash
arg="$(echo ${1:-.}| sed -r 's#/+#/#g')"
[[ ! -e "${arg}" ]] && FZF_QUERY="$1"

FZF_PROMPT="$(basename $0)"
FZF_HEADER="C-g:ripgrep, C-/:TogglePreview"

FIND_RESULT=$(find -s ${arg} \
  -not -regex '.*/.git' \
  -not -regex '.*/.git/.*' \
  -not -regex '.*\.DS_Store' \
  -maxdepth 5 2>/dev/null| grep -v "^${arg}$")
  # -maxdepth 2 2>/dev/null| grep -v "^${arg}$")
CANDIDATES=$(printf "${arg}/..\n${FIND_RESULT}"| sed -r 's#^(\.\/\/)##'| sed -r 's#/+#/#g')
FZF_RESULT=$(echo "${CANDIDATES}" \
  | fzf +m \
  --prompt="${FZF_PROMPT} (dir='$(home_as_tilde ${arg})') > " \
  --preview-window=right:60%:wrap \
  --preview='
    home_as_tilde $(realpath {})
    echo "---"
    bat $(home_as_home {}) --color=always --style=numbers --line-range :100
  '\
  --query="${FZF_QUERY}" \
  --header="${FZF_HEADER}" \
  --bind "ctrl-/:toggle-preview" \
  --bind "ctrl-g:execute(rg_fzf_vim . ${HOME_AS_HOME} < /dev/tty > /dev/tty)" \
)

relative_path="$(realpath --relative-to=. ${FZF_RESULT:-${arg}})"
[[ -d ${relative_path} ]] && relative_path="${relative_path}/"
echo -n "${relative_path}"

