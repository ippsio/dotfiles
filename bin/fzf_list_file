#!/bin/bash
# ファイルの選択I/Fをする。
# プレビュー：ファイル内の内容。
FIND_TARGET=${1:-./}
READABLE_PATH=$(echo ${FIND_TARGET}| sed "s#~#${HOME}#"| xargs realpath| sed -e "s#^${HOME}#~#")

_FZF_PROMPT="$(basename $0)"
_FZF_HEADER="[keybind] ?:preview, C-g:rg(${READABLE_PATH}/), ctrl-f:rg(file)]"
SELECTED=$(find -s -E ${FIND_TARGET/'~'/${HOME}} -not -regex '.*(\.DS_Store|/*.git/).*' -and \
  | sed -e 's#\/\/*#\/#g' \
  | sed -e "s#^${HOME}#~#" \
  | fzf +m \
  --prompt="${_FZF_PROMPT} (dir=${READABLE_PATH}) > " \
  --header="${_FZF_HEADER}" \
  --bind "?:toggle-preview" \
  --bind "ctrl-f:execute(rg_fzf_vim . {} < /dev/tty > /dev/tty)" \
  --bind "ctrl-g:execute(rg_fzf_vim . ${FIND_TARGET} < /dev/tty > /dev/tty)" \
  --preview '
    _dir=$(echo $(cd $(dirname $(echo {}| sed -e "s#^~#${HOME}#")) && pwd));
    _file=$(echo {}| sed -e "s#^~#${HOME}#"| sed -e "s#^.*/##");
    bat ${_dir}/${_file} --color=always --style=numbers --line-range :100
  ')

if [[ ! -z "${SELECTED}" ]]; then
  if [[ -d $(echo ${SELECTED}| sed -e "s#~#${HOME}#") ]]; then
    # 選択されたのがディレクトリなら、末尾に/を付ける。
    echo -n "${SELECTED}/"
  else
    echo -n "${SELECTED}"
  fi
else
  echo -n "$1" && exit 1
fi

