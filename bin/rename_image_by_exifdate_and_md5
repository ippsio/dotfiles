#!/bin/bash
f="$1"
if [[ ! -e "$f" ]]; then
  echo "ファイルが見つかりません。処理終了します(${f})"
  exit 1
fi

fdir=$(dirname "$f")
exif=$(exiftool -t\
  -dateFormat "%Y_%m_%d_%H%M%S"\
  -allDates\
  -fileTypeExtension "$f")

dt=$(echo "$exif"\
  | grep -v "File Type Extension"\
  | awk -F '\t' '{ print $2 }'\
  | sort\
  | head -1)
dt=${dt:-0000_00_00_000000}
ext_org=$(echo "$exif"\
  | grep "File Type Extension"\
  | awk -F '\t' '{ print $2 }'\
  | sed -E 's/.*\.//'\
  | tr 'A-Z' 'a-z')

ext_new=""
[[ -z "${ext_new}" && "${ext_org}" == "gif"  ]] && ext_new="gif"
[[ -z "${ext_new}" && "${ext_org}" == "heic" ]] && ext_new="heic"
[[ -z "${ext_new}" && "${ext_org}" == "jpg"  ]] && ext_new="jpg"
[[ -z "${ext_new}" && "${ext_org}" == "jpeg" ]] && ext_new="jpg"
[[ -z "${ext_new}" && "${ext_org}" == "mov"  ]] && ext_new="mov"
[[ -z "${ext_new}" && "${ext_org}" == "mp4"  ]] && ext_new="mp4"
[[ -z "${ext_new}" && "${ext_org}" == "3gp"  ]] && ext_new="mp4"
[[ -z "${ext_new}" && "${ext_org}" == "png"  ]] && ext_new="png"
[[ -z "${ext_new}" && "${ext_org}" == "tif"  ]] && ext_new="tif"
[[ -z "${ext_new}" ]] && ext_new="${ext_org}"

if [[ -z "${ext_new}" ]]; then
  echo "想定外の拡張子だったようです。処理終了します(${f})"
  exit 1
fi

md5=$(md5sum "$f"| awk '{ print $1 }')
if [[ -z "${md5}" ]]; then
  echo "md5が計算できませんでした。処理終了します(${f})"
  exit 1
fi

new_fname="${dt}_${md5}.${ext_new}"
if [[ "${f}" == "${new_fname}" ]]; then
  echo "既に処理済みです。処理終了します(${f})"
  exit 1
fi

new_f="${fdir}/${new_fname}"
mv_cmd="mv \"$f\" \"${new_f}\""
echo "${mv_cmd}"
eval "${mv_cmd}"

