#!/bin/bash

file="$1"
line_highlight="${2:-1}"
query=$(echo "${3} ${4} ${5} ${6} ${7} ${8} ${9} ${10}"| xargs echo| sed "s/^[[:blank:]]*//"| sed -E "s/[[:blank:]]+$//g"| sed -E "s/[[:blank:]]+/\|/g");
line_from=$(($line_highlight - 5 <= 0 ? 1 : $line_highlight - 5 ));
line_to=$(($line_from + 127));
git_repo=$(git remote get-url origin 2> /dev/null| grep -Eo "([a-zA-Z0-9_+-]+)\/([a-zA-Z0-9_+-]+)(.git)?$");
git_branch=$(git branch --show-current 2> /dev/null);
echo "GIT={${git_repo}  $git_branch}";
echo "FILE=${file}";
echo "QUERY=${query}";
if [[ -z $file ]]; then
  echo "No results"
else
  if [[ ! -z $git_repo ]]; then
    git blame --show-name $file \
      | awk '{ printf "%s%s\n", substr($0, 0, index($0, " ") - 1), substr($0, index($0, " (")) }' \
      | awk '
        BEGIN {
          H["0"] = 0; H["1"] = 1; H["2"] = 2; H["3"] = 3; H["4"] = 4; H["5"] = 5; H["6"] = 6; H["7"] = 7;
          H["8"] = 8; H["9"] = 9; H["A"] = 10;H["B"] = 11; H["C"] = 12;H["D"] = 13;H["E"] = 14;H["F"] = 15;
          PR[""] = "";
        } {
          HASH=$1; H1 = toupper(substr(HASH, 2, 1)); H2 = toupper(substr(HASH, 3, 1));
          COLOR = H[H1] * 16 + H[H2];
          printf("\033[38;5;%dm", COLOR);
          printf("%s", HASH);

          if (!( HASH in PR_NO)) { "~/dotfiles/bin/git_pr_no_by_hash " HASH | getline var; PR[HASH] = var };
          printf("%s", PR[HASH]);

          printf("\033[0m");
          sub(/[\^a-f0-9]+/, "", $0); # コミットハッシュ部分削除
          sub(/:[0-9]{2} \+[0-9]{4}/, "", $0); # コミット日時の秒とタイムゾーン部分削除
          printf "%s\n", $0;
        }' \
      | rg --smart-case --passthru --color=always "${query}" \
      | bat --wrap auto --no-pager --style plain --color=always --line-range $line_from: --highlight-line $line_highlight;
  fi
fi

