#!/bin/bash
readonly FILE=~/.completion_candidates/goto
readonly COLOR="[38;5;170m"
readonly COLOR0="[0m"
readonly TAB="	"

# ç§»å‹•å…ˆãƒ•ã‚©ãƒ«ãƒ€ã®å€™è£œã‚’ä½œã‚Šã¾ã™ã€‚
candidates=$(while read line; do
  # NOTE: lineã®å®šç¾©å†…å®¹ã¯ã“ã‚“ãªæ„Ÿã˜
  # > 1è¡Œç›®:dotfiles #vim   ,cd,~/dotfiles/.config/nvim
  # > 2è¡Œç›®:dotfiles        ,cd,~/dotfiles
  # > 3è¡Œç›®:   (ç•¥)
  tags=$(echo "${line}"| awk -F ',' '{ print $1 }')
  cmd=$(echo "${line}"| awk -F ',' '{ print $2 }')
  path=$(echo "${line}"| awk -F ',' '{ print $3 }')
  idx=$(( ${idx:-0} + 1 ))
  if [[ "${path: -2}" != "/*" ]]; then
    printf "${idx} ${COLOR}${tags}${COLOR0}${TAB}${cmd} ${path}\n"
  else
    sub_idx=0
    for grandchild in $(find ~/ghq/github.com -type d -maxdepth 2 -mindepth 2); do
      sub_idx=$(( sub_idx + 1 ))
      sub_idx_s=$(printf "%02d" "${sub_idx}")
      basename_of_grandchild="#$(basename ${grandchild})"
      printf "${idx}-${sub_idx_s} ${COLOR}${basename_of_grandchild} ${tags}${COLOR0}${TAB}${cmd} ${grandchild}\n"
    done
  fi
done < ${FILE})

# ç§»å‹•å…ˆã‚’é¸æŠžã—ã¾ã™ã€‚
select_result=$(echo "${candidates}"\
  | fzf-tmux \
    --tabstop=1 \
    --info=inline \
    --prompt="$(basename $0) " \
    --header="source file='$(home_as_tilde ${FILE})'" \
    --ansi \
    --query="#"
)

# é¸æŠžã—ãŸç§»å‹•å…ˆã‚’è¿”ã—ã¾ã™ã€‚
result=$(echo "${select_result}"| awk -F "${TAB}" '{ print $2 }')
if [[ ! -z "${result}" ]]; then
  echo "${result}"
fi
