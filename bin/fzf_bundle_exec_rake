#!/bin/bash

# bundle exec rakeで実行するタスクの候補を表示する。
# プレビューとして、タスクのソースコードを表示する。

files=$(find . -name vendor -prune -o -name '*.rake' -print) || return
target=$(
  find . -name vendor -prune -o -name '*.rake' -print| xargs -I {} grep "task_with_logger" -nH {}| awk -F ":" '{print $1" "$2" "$3" "$4 }'| sed -e 's/,//g'| sed -e 's/task_with_logger//'| awk '{ print $1" " $2" "$3}' \
    | fzf --bind change:top \
  --bind "ctrl-v:execute(nvim {1} < /dev/tty > /dev/tty)" \
  --bind 'ctrl-/:toggle-preview' --preview "bat --color=always --highlight-line {2} {1}" \
  --preview-window=right:60%:wrap
)
#echo "${target}" | perl -pe 's#.*/##g' | perl -pe 's#\.rake$/##g'
echo "${target}"|awk '{print $1":"$3}' |perl -pe 's#.*/##g' | perl -pe 's#\.rake:#:#g'

