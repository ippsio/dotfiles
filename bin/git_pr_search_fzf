#!/bin/bash

commit=$1
if [ -L $0 ]
then
  ME=$(basename $(readlink $0))
else
  ME=$(basename $0)
fi

FZF_PROMPT="$ME commit='${commit}' > "
FZF_HEADER="enter:neovim, tab:open browser"
TEMPLATE="echo '# commit: ${commit} に関するpull request です。
- No: [{1}]
- State: [{2}]
- Author: [{3}]
- Title: [{4}]
- Created_at: [{7}]
- Updated_at: [{8}]
- Closed_at:  [{9}]
---------------------------------------------------

'{5}"

if ( is_git_hash "$1" ); then
  git_pr_search_hash "${commit}"| \
    fzf \
      --no-sort \
      --prompt="${FZF_PROMPT}" \
      --header="${FZF_HEADER}" \
      --delimiter='\t' \
      --bind "enter:execute(${TEMPLATE}| sed -e 's/\r//g'| nvim -Ro -c \"set ft=markdown\" > /dev/tty)" \
      --bind "tab:execute(open '{6}')" \
      --preview="${TEMPLATE}| bat --language=md" \
      --preview-window=75%

elif ( is_git_branch "$1" ); then
  git_pr_search_branch "${commit}"| \
    fzf \
      --no-sort \
      --prompt="${FZF_PROMPT}" \
      --header="${FZF_HEADER}" \
      --delimiter='\t' \
      --bind "enter:execute(${TEMPLATE}| sed -e 's/\r//g'| nvim -Ro -c \"set ft=markdown\" > /dev/tty)" \
      --bind "tab:execute(open '{6}')" \
      --preview="${TEMPLATE}| bat --language=md" \
      --preview-window=75%

fi
