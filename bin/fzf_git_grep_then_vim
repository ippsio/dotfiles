#!/bin/bash

# git_grep_fzf_vim
# git grep earch + fzf filter +  edit with vim .
SEARCH_WORD=${1:-.}
GIT_GREP_CMD="git grep --line-number ${SEARCH_WORD}"
FZF_PROMPT="$(basename $0): '${GIT_GREP_CMD}'"
FZF_HEADER="enter:nvim"

eval "${GIT_GREP_CMD}" \
  | perl -pe 's/(^.*):(\d+):(.*)$/\1	\2	\3/' \
  | fzf -m \
    --info=inline \
    --ansi \
    --delimiter='	' \
    --tabstop=2 \
    --prompt="${FZF_PROMPT} > " \
    --header="${FZF_HEADER}" \
    --bind "enter:execute(nvim {1} +{2} < /dev/tty > /dev/tty)" \
    --preview='
      # 原則、検索ヒットした行の5行前から表示。
      from=$(expr {2} - 5);
      [[ ${from} -lt 1 ]] && from=1;
      bat \
        --color=always \
        --style=numbers,header \
        --line-range ${from}: \
        --highlight-line {2} {1}
      '

