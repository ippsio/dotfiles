#!/bin/bash

_ME=$( [ -L $0 ] && basename $(readlink $0) || basename $0)
PR_HEAD_BASE_CSV="$(git_root)/../${_ME}.csv"
_DELIMITER='\t'

_csv_load() { touch ${PR_HEAD_BASE_CSV} && grep "^$1${_DELIMITER}" ${PR_HEAD_BASE_CSV}| head -n 1 || echo ""; }
_csv_write() { echo -e "$1${_DELIMITER}$2${_DELIMITER}$3${_DELIMITER}$4${_DELIMITER}$(date +'%Y-%m-%d %H:%M:%S')" >> ${PR_HEAD_BASE_CSV}; }

CURRENT_BRANCH=$1
CSV_DATA=$(_csv_load "${CURRENT_BRANCH}")
if [[ "${CSV_DATA}" != "" ]]; then
  BY="${PR_HEAD_BASE_CSV//${HOME}/~}"
  MB_BRANCH="$(echo "${CSV_DATA}"| awk -F '\t' '{ print $2 }')"
  PR_NO="$(echo "${CSV_DATA}"| awk -F '\t' '{ print $3 }')"
  PR_TITLE="$(echo "${CSV_DATA}"| awk -F '\t' '{ print $4 }')"
else
  for TMP_PR_NO in $(git_search_pr_by_branch "${CURRENT_BRANCH}"| awk -F '\t' '{ print $1 }'); do
    if [[ "${TMP_PR_NO}" != "GIT_SEARCH_PR:PR_NOT_FOUND" ]]; then
      PR_INFO=$(git_get_prinfo "${TMP_PR_NO}")
      HEAD_REF=$(echo "${PR_INFO}"| jq -r '.head.ref')
      BASE_REF=$(echo "${PR_INFO}"| jq -r '.base.ref')
      if [[ "$HEAD_REF" == "${CURRENT_BRANCH}" && "${BASE_REF}" != "" ]]; then
        PR_NO=$TMP_PR_NO
        PR_TITLE=$(echo "${PR_INFO}"| jq -r '.title')
        MB_BRANCH=${BASE_REF}
        BY="github-api";
        _csv_write "${CURRENT_BRANCH}" "${MB_BRANCH}" "${PR_NO}" "${PR_TITLE}"
        break
      fi
    fi
  done
  if [[ -z $PR_NO ]]; then
    BY="manual-1"; MB_BRANCH=$(git_branch_fzf "--respond_me_branch")
  fi
fi
echo -e "MERGE_BASE_BRANCH=${MB_BRANCH}\nCURRENT_BRANCH=${CURRENT_BRANCH}\nPR_NO=${PR_NO}\nPR_TITLE=${PR_TITLE}\nBY=${BY}"

