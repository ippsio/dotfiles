#!/bin/bash

BRANCH1=$1
BRANCH2=$2

if [ -L $0 ]
then
  ME=$(basename $(readlink $0))
else
  ME=$(basename $0)
fi
CSV="$(git_root)/../${ME}.csv"

csv_load() {
  touch ${CSV}
  grep "^$1	" ${CSV}| head -n 1 || echo "";
}
csv_write() {
  echo "$1	$2	$3	$4	$(date +'%Y-%m-%d %H:%M:%S')" >> ${CSV}i
}

if [[ ! -z "${BRANCH2}" ]]; then
  BY="given"
  MB_BRANCH="${BRANCH2}"
  PR_NUMBER=""
  PR_TITLE=""

else
  CSV_DATA=$(csv_load "${BRANCH1}")
  if [[ ! -z "${CSV_DATA}" ]]; then
    BY="$(home_as_tilde ${CSV})"
    MB_BRANCH="$(echo "${CSV_DATA}"| awk -F '\t' '{ print $2 }')"
    PR_NUMBER="$(echo "${CSV_DATA}"| awk -F '\t' '{ print $3 }')"
    PR_TITLE="$(echo "${CSV_DATA}"| awk -F '\t' '{ print $4 }')"

  else
    for TMP_PR_NUMBER in $(git_pr_search_branch "${BRANCH1}"| awk -F '\t' '{ print $1 }'); do
      if [[ "${TMP_PR_NUMBER}" == "GIT_SEARCH_PR:PR_NOT_FOUND" ]]; then
        continue
      fi

      GIT_PR_GET_RESULT=$(git_pr_get "${TMP_PR_NUMBER}")
      HEAD_REF=$(echo "${GIT_PR_GET_RESULT}"| jq -r '.head.ref')
      BASE_REF=$(echo "${GIT_PR_GET_RESULT}"| jq -r '.base.ref')

      if [[ "$HEAD_REF" == "${BRANCH1}" && "${BASE_REF}" != "" ]]; then
        MB_BRANCH="${BASE_REF}"
        PR_NUMBER="${TMP_PR_NUMBER}"
        PR_TITLE=$(echo "${GIT_PR_GET_RESULT}"| jq -r '.title')
        BY="github-api";

        csv_write "${BRANCH1}" "${MB_BRANCH}" "${PR_NUMBER}" "${PR_TITLE}"
        break
      fi
    done
  fi
fi

if [[ -z "${MB_BRANCH}" ]]; then
  BY="manual-1"
  MB_BRANCH=$(git_branch_fzf)
fi

echo -e "MERGE_BASE_BRANCH=${MB_BRANCH}\nCURRENT_BRANCH=${BRANCH1}\nPR_NO=${PR_NUMBER}\nPR_TITLE=${PR_TITLE}\nBY=${BY}"

