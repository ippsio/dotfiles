#!/bin/bash
IFS=$'\n'
window_pane_list=$(for window in $(tmux list-windows -F "#{window_index},#{?window_active,A,}" ); do
  window_index=$(echo "${window}"| awk -F ',' '{ print $1 }')
  window_active=$(echo "${window}"| awk -F ',' '{ print $2 }')
  for pane in $(tmux list-panes -F "#{pane_index},#{?pane_active,A,}" -t "${window_index}" ); do
    pane_index=$(echo "${pane}"| awk -F ',' '{ print $1 }')
    pane_active=$(echo "${pane}"| awk -F ',' '{ print $2 }')
    window_pane="${window_index},${pane_index}"
    if [[ "${window_active}" == "A" && "${pane_active}" == "A" ]]; then
      window_pane="${window_pane}A"
    fi
    echo "${window_pane}"
  done
done)

if [[ "$1" == "--reverse" ]]; then
  window_pane_list=$(echo "${window_pane_list}"| tac)
fi
grep_a1_result=$(echo "${window_pane_list}"| grep -A 1 "A")
grep_a1_result_count=$(echo "${grep_a1_result}"| wc -l| tr -d ' ')
if [[ ${grep_a1_result_count} -eq 1 ]]; then
  next_window_pane=$(echo "${window_pane_list}"| head -1)
elif [[ ${grep_a1_result_count} -eq 2 ]]; then
  next_window_pane=$(echo "${grep_a1_result}"| tail -n 1)
fi

next_window_index=$(echo "${next_window_pane}"| awk -F ',' '{ print $1 }')
next_pane_index=$(echo "${next_window_pane}"| awk -F ',' '{ print $2 }')

tmux select-window -t ${next_window_index}
tmux select-pane -t ${next_pane_index}
tmux set -g window-active-style "bg=colour52"
tmux display-panes -d 200
tmux set -g window-active-style "bg=colour0"

