#!/bin/bash
#
# rg(ripgrep)の検索結果を選択I/Fを表示する。
# さらに、選択したファイルをvimで開く
# fzfのプレビューは、基本的に検索ヒットした行の5行前から表示する(decide_from)。
ARG=${1:-.}
EXEC_DIR_OR_FILE=$(echo ${2:-$(pwd)}| sed -e "s#~#${HOME}#"| xargs realpath)
PWD_TO_SHOW=$(echo ${EXEC_DIR_OR_FILE}| sed -e "s#^${HOME}#~#")

_ME=$( [ -L $0 ] && basename $(readlink $0) || basename $0)
if [ -d ${EXEC_DIR_OR_FILE} ]; then
  EXEC_DIR=${EXEC_DIR_OR_FILE}
  GLOB=""
else
  EXEC_DIR=$(dirname ${EXEC_DIR_OR_FILE})
  GLOB="-g $(basename ${EXEC_DIR_OR_FILE})"
fi

_FZF_PROMPT="${_ME} (dir=${PWD_TO_SHOW}) (q=$ARG)> "
_FZF_HEADER="[keybind] enter:nvim"

cd ${EXEC_DIR} && \
  rg --hidden --line-number ${GLOB} ${ARG} \
  | perl -pe 's/(^.*):(\d+):(.*)$/\1 \2 \3/' \
  | fzf -m \
    --prompt="${_FZF_PROMPT}" \
    --header="${_FZF_HEADER}" \
    --bind "enter:execute(nvim {1} +{2} < /dev/tty > /dev/tty)" \
    --preview '
      decide_range_from() { echo $(( $1 - 5 > 0 ? $1 - 5 : 1)) };
      bat --color=always --style=numbers,header \
        --line-range $(decide_range_from {2}): \
        --highlight-line {2} {1}'
