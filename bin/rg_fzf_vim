#!/bin/bash
#
# rg(ripgrep)の検索結果を選択I/Fを表示する。
# さらに、選択したファイルをvimで開く
# fzfのプレビューは、基本的に検索ヒットした行の5行前から表示する(decide_from)。
SEARCH_WORD=${1:-.}
HOME_AS_HOME=$(realpath ${2:-$(pwd)}| home_as_home)
HOME_AS_TILDE=$(echo ${HOME_AS_HOME}| sed -e "s#^${HOME}#~#")

# `man test` => -L: True if file exists and is a symbolic link.
if [ -L $0 ] && basename $(readlink $0)
then
  _ME=$(basename $(readlink $0))
else
  _ME=$(basename $0)
fi

if [ -d ${HOME_AS_HOME} ]; then
  DIR=${HOME_AS_HOME}
  GLOB=""
else
  DIR=$(dirname ${HOME_AS_HOME})
  GLOB="-g $(basename ${HOME_AS_HOME})"
fi

RG_CMD="cd ${DIR} && rg --hidden --line-number ${GLOB} ${SEARCH_WORD}"
FZF_PROMPT="${_ME}: ${RG_CMD} > "
FZF_HEADER="enter:nvim"

eval "${RG_CMD}"\
  | perl -pe 's/(^.*):(\d+):(.*)$/\1	\2	\3/' \
  | fzf \
    -m \
    --ansi \
    --delimiter='	' \
    --tabstop=2 \
    --prompt="${_ME}: ${RG_CMD}" \
    --header="${FZF_HEADER}" \
    --bind "enter:execute(nvim {1} +{2} < /dev/tty > /dev/tty)" \
    --preview='
      decide_range_from() { echo $(( $1 - 5 > 0 ? $1 - 5 : 1)) };
      bat \
        --color=always \
        --style=numbers,header \
        --line-range $(decide_range_from {2}): \
        --highlight-line {2} {1}
      '
