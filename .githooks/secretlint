#!/bin/bash

# ----------------
# npxã®ãƒ‘ã‚¹ã‚’æ¢ã™
# ----------------
dir_ar=()
dir_ar+=( ~/.nodenv/shims )
dir_ar+=( /usr/local/bin )
dir_ar+=( ~/.anyenv/envs/nodenv/shims )
dir_ar+=( ~/.asdf/shims )
dir=""
for folder in ${dir_ar[@]}; do
  (type "${folder}/npx" > /dev/null 2>&1) && dir="${folder}" && break
done
[[ -z ${dir} ]] && IFS=',' && echo "no npx was found on any of ( ${dir_ar[*]} )." && exit 1

# ----------------
# npxã®å®Ÿè¡Œ
# ----------------
# NOTE: `sed 's|ã€€|\\ã€€|g'` ã®ç›®çš„ï¼ãƒ•ã‚¡ã‚¤ãƒ«åã«åŠè§’ã‚¹ãƒšãƒ¼ã‚¹ã‚’å«ã‚€æ™‚ã€ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã™ã‚‹ã“ã¨ã€‚
#FILES=$(git diff --cached --name-only --diff-filter=ACMR | sed 's| |\\ |g')
FILES=$(git ls-files| sed 's| |\\ |g')
[ -z "$FILES" ] && exit 0
echo -e "FILES TO BE CHECKED:"
i=0; for f in ${FILES}; do
  echo -n " ($i)$f"; i=$(expr $i + 1)
done
echo -e "$FILES" | xargs -t ${dir}/npx secretlint

# -------------------
# npxã®å®Ÿè¡Œçµæœã®åˆ¤å®š
# -------------------
RET=$?
[ $RET -eq 0 ] && echo -e "\nGOOD!ğŸ‘ secretlint passed successfully." && exit 0

exit 1
